<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>தமிழ் AI Chatbot + Email</title>
<style>
body { font-family: Arial; background:#111; color:#fff; text-align:center; }
#chat { width: 80%; max-width: 600px; margin:20px auto; background:#222; padding:15px; border-radius:10px; }
.msg { margin:10px; padding:10px; border-radius:6px; }
.user { background:#444; text-align:right; }
.bot { background:#2a2a6a; text-align:left; white-space: pre-line; }
.sources { font-size:12px; color:#aaa; margin-top:5px; }
input { padding:8px; border-radius:5px; border:none; }
button { padding:8px 15px; border-radius:5px; border:none; background:#4caf50; color:white; cursor:pointer; }
</style>
</head>
<body>
<h1>💬 தமிழ் AI Chatbot</h1>
<div id="chat"></div>
<input id="q" type="text" placeholder="உங்கள் கேள்வியை இங்கே type செய்யவும்..." style="width:70%">
<button onclick="ask()">கேள்</button>

<!-- Hidden Netlify Form -->
<form name="user-questions" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="question" id="hiddenQuestion">
</form>

<script>
// ✅ Local variable answers
const localAnswers = {
  "வணக்கம்": "வணக்கம்! எப்படி இருக்கிறீர்கள்?",
  "உன் பெயர் என்ன": "என் பெயர் தமிழ் Cyber Zone AI 🤖",
  "car": "Car என்பது ஒரு வாகனம் 🚗"
};

// ✅ Voices load fix
let voices = [];
window.speechSynthesis.onvoiceschanged = () => {
  voices = window.speechSynthesis.getVoices();
};

// ✅ Voice output
function speak(text){
  if('speechSynthesis' in window){
    const utter = new SpeechSynthesisUtterance(text.replace(/<br>/g,' '));
    const tamilVoice = voices.find(v=>v.lang.startsWith('ta')) || voices.find(v=>v.lang.startsWith('en')) || voices[0];
    if(tamilVoice) utter.voice = tamilVoice;
    window.speechSynthesis.speak(utter);
  }
}

// ✅ Silent Email send (via Netlify form)
function sendToEmail(userInput){
  const formData = new FormData();
  formData.append("form-name", "user-questions");
  formData.append("question", userInput);

  fetch("/", {
    method: "POST",
    body: formData
  }).catch((error) => console.error("Form submit error:", error));
}

// ✅ Main chatbot
async function ask(){
  const q = document.getElementById("q").value.trim();
  if(!q) return;
  addMsg("user", q);
  document.getElementById("q").value = "";

  let finalAnswer = "";
  let sources = [];
  let moreLinks = [];

  // 1️⃣ Local variable check
  if(localAnswers[q]){
    finalAnswer = localAnswers[q];
    sources.push("Local Variable");
    addMsg("bot", finalAnswer + sourceText());
    speak(finalAnswer);
    return;
  } else {
    // Not found in local → send to Netlify form (silent)
    sendToEmail(q);
  }

  // 2️⃣ Wikipedia
  try{
    let wiki = await fetch(`https://ta.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`);
    if(wiki.ok){
      let j = await wiki.json();
      if(j.extract){
        finalAnswer += "📖 Wikipedia: " + j.extract + "\n\n";
        sources.push("Wikipedia");
        moreLinks.push(j.content_urls?.desktop?.page);
      }
    }
  }catch(e){console.error(e);}

  // 3️⃣ DuckDuckGo
  try{
    let ddg = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_redirect=1&no_html=1`);
    if(ddg.ok){
      let j = await ddg.json();
      if(j.AbstractText){
        finalAnswer += "🔎 DuckDuckGo: " + j.AbstractText + "\n\n";
        sources.push("DuckDuckGo");
        if(j.AbstractURL) moreLinks.push(j.AbstractURL);
      }
    }
  }catch(e){console.error(e);}

  // 4️⃣ OpenLibrary
  try{
    let ol = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}`);
    if(ol.ok){
      let j = await ol.json();
      if(j.docs && j.docs.length>0){
        finalAnswer += "📚 OpenLibrary: " + j.docs[0].title + "\n\n";
        sources.push("OpenLibrary");
        moreLinks.push("https://openlibrary.org" + j.docs[0].key);
      }
    }
  }catch(e){console.error(e);}

  // 5️⃣ Fallback
  if(!finalAnswer) finalAnswer = "மன்னிக்கவும், பதில் கிடைக்கவில்லை.";

  addMsg("bot", finalAnswer + sourceText());
  speak(finalAnswer.replace(/📖|🔎|📚/g,""));

  function sourceText(){
    return sources.length ? `<div class='sources'>மூலம்: ${sources.join(", ")}<br>மேலும் பார்க்க: ${moreLinks.map(l=>`<a href="${l}" target="_blank">${l}</a>`).join(", ")}</div>` : "";
  }
}

// ✅ Chat UI
function addMsg(type, text){
  let div = document.createElement("div");
  div.className = "msg " + type;
  div.innerHTML = text;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
}
</script>
</body>
</html>
